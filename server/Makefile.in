
TARGET_EXPORTS    = apache.exports
CLEAN_TARGETS = gen_test_char gen_uri_delims test_char.h uri_delims.h \
	$(TARGET_EXPORTS)

SUBDIRS = mpm

LTLIBRARY_NAME    = libmain.la
LTLIBRARY_SOURCES = \
    uri_delims.h test_char.h \
	config.c log.c main.c vhost.c util.c util_date.c \
	util_script.c util_uri.c util_md5.c util_cfgtree.c util_ebcdic.c \
	rfc1413.c connection.c listen.c \
        mpm_common.c util_charset.c util_debug.c util_xml.c \
	util_filter.c exports.c buildmark.c scoreboard.c

targets = delete-exports $(LTLIBRARY_NAME)

include $(top_srcdir)/build/rules.mk
include $(top_srcdir)/build/library.mk

gen_uri_delims_OBJECTS = gen_uri_delims.lo
gen_uri_delims: $(gen_uri_delims_OBJECTS)
	$(LINK) $(EXTRA_LDFLAGS) $(gen_uri_delims_OBJECTS) $(EXTRA_LIBS)

gen_test_char_OBJECTS = gen_test_char.lo util_debug.lo
gen_test_char: $(gen_test_char_OBJECTS)
	$(LINK) $(EXTRA_LDFLAGS) $(gen_test_char_OBJECTS) $(EXTRA_LIBS)

uri_delims.h: gen_uri_delims
	./gen_uri_delims > uri_delims.h

test_char.h: gen_test_char
	./gen_test_char > test_char.h

util_uri.lo: uri_delims.h
util.lo: test_char.h

EXPORT_FILES = ../srclib/apr/apr.exports ../srclib/apr-util/aprutil.exports \
	$(TARGET_EXPORTS)

delete-exports:
	@if test -f $(TARGET_EXPORTS); then \
		    headers="`find ../include/*.h -newer $(TARGET_EXPORTS)`" ; \
		    if test -n "$$headers"; then \
		        echo Found newer headers. Will rebuild $(TARGET_EXPORTS). ; \
		        echo rm -f $(TARGET_EXPORTS) ; \
		        rm -f $(TARGET_EXPORTS) ; \
		    fi \
	fi


$(TARGET_EXPORTS):
	$(AWK) -f $(top_srcdir)/srclib/apr/helpers/make_export.awk $(top_srcdir)/include/*.h > $@

exports.c: $(EXPORT_FILES)
	(cat $(EXPORT_FILES) | ../build/buildexports.sh ..) > $@
