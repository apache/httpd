
TARGET_EXPORTS    = apache.exports
CLEAN_TARGETS = gen_test_char test_char.h gen_uri_delims uri_delims.h \
	$(TARGET_EXPORTS) ApacheCoreOS2.def
DISTCLEAN_TARGETS = httpd.exp
EXTRACLEAN_TARGETS = exports.c export_vars.c

SUBDIRS = mpm

LTLIBRARY_NAME    = libmain.la
LTLIBRARY_SOURCES = \
    test_char.h \
	config.c log.c main.c vhost.c util.c \
	util_script.c util_md5.c util_cfgtree.c util_ebcdic.c \
	rfc1413.c connection.c listen.c \
        mpm_common.c util_charset.c util_debug.c util_xml.c \
	util_filter.c exports.c buildmark.c scoreboard.c \
	error_bucket.c protocol.c core.c request.c

TARGETS = delete-exports $(LTLIBRARY_NAME) $(CORE_IMPLIB_FILE) export_vars.c \
	httpd.exp

include $(top_srcdir)/build/rules.mk
include $(top_srcdir)/build/library.mk

gen_test_char_OBJECTS = gen_test_char.lo util_debug.lo
gen_test_char: $(gen_test_char_OBJECTS)
	$(LINK) $(EXTRA_LDFLAGS) $(gen_test_char_OBJECTS) $(EXTRA_LIBS)

test_char.h: gen_test_char
	./gen_test_char > test_char.h

util.lo: test_char.h

EXPORT_FILES = $(top_srcdir)/srclib/apr/apr.exports \
	$(top_srcdir)/srclib/apr-util/aprutil.exports \
	$(TARGET_EXPORTS)

delete-exports:
	@if test -f $(TARGET_EXPORTS); then \
		    headers="`find $(top_srcdir)/include/*.h -newer $(TARGET_EXPORTS)`" ; \
		    if test -n "$$headers"; then \
		        echo Found newer headers. Will rebuild $(TARGET_EXPORTS). ; \
		        echo rm -f $(TARGET_EXPORTS) ; \
		        rm -f $(TARGET_EXPORTS) ; \
		    fi \
	fi


$(TARGET_EXPORTS):
	$(AWK) -f $(top_srcdir)/srclib/apr/build/make_export.awk \
		$(top_srcdir)/include/*.h \
		$(top_srcdir)/os/$(OS_DIR)/*.h > $@

exports.c: $(EXPORT_FILES)
	(cat $(EXPORT_FILES) | $(top_srcdir)/build/buildexports.sh $(top_srcdir)) > $@

export_vars.c:
	$(AWK) -f $(top_srcdir)/build/make_var_export.awk $(top_srcdir)/include/*.h $(top_srcdir)/os/$(OS_DIR)/*.h $(top_srcdir)/srclib/apr/include/*.h $(top_srcdir)/srclib/apr-util/include/*.h > $@

# wtf does this have to be explicit????
exports.lo: exports.c

# Rule to make def file for OS/2 core dll
ApacheCoreOS2.def: exports.c $(top_srcdir)/os/$(OS_DIR)/core_header.def
	cat $(top_srcdir)/os/$(OS_DIR)/core_header.def > $@
	$(CPP) $< $(ALL_CPPFLAGS) $(ALL_INCLUDES) | grep "ap_hack_" | sed -e 's/^.*[)]\(.*\);$$/  "\1"/' >> $@

# Rule to make exp file for AIX DSOs
httpd.exp: exports.c export_vars.c
	echo "#! ." > $@
	$(CPP) $(ALL_CPPFLAGS) $(ALL_INCLUDES) exports.c | grep "ap_hack_" | sed -e 's/^.*[)]\(.*\);$$/\1/' >> $@
	$(CPP) $(ALL_CPPFLAGS) $(ALL_INCLUDES) export_vars.c | sed -e 's/^\#[^!]*//' | sed -e '/^$$/d' >> $@
