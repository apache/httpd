
SUBDIRS = ap lib main modules os support

PROGRAM_NAME         = $(progname)
PROGRAM_SOURCES      = modules.c buildmark.c
PROGRAM_LDADD        = $(EXTRA_LDFLAGS) $(PROGRAM_DEPENDENCIES) $(EXTRA_LIBS)
PROGRAM_DEPENDENCIES = \
  $(BUILTIN_LIBS) \
  $(MPM_LIB) \
  main/libmain.la \
  os/$(OS_DIR)/libos.la \
  ap/libap.la \
  $(AP_LIBS)

PROGRAMS        = $(PROGRAM_NAME)
targets         = $(PROGRAMS)
phony_targets   = $(srcdir)/buildmark.c
install_targets = install-conf install-htdocs install-icons install-other \
	install-cgi install-include install-support
DISTCLEANFILES  = include/config_auto.h modules.c aclocal.m4 buildmk.stamp \
	configure generated_lists include/ap_config_auto.h \
	include/ap_config_auto.h.in include/ap_config_path.h install-sh

include $(top_srcdir)/build/rules.mk
include $(top_srcdir)/build/program.mk

install-conf:
	@echo Installing configuration files
	@test -d $(sysconfdir) || $(MKINSTALLDIRS) $(sysconfdir)
	@cd $(srcdir)/../conf; \
	for i in mime.types magic; do \
		$(INSTALL_DATA) $$i $(sysconfdir); \
	done; \
	for i in *-dist; do \
		sed -e 's#@@ServerRoot@@#$(prefix)#g' \
		    -e 's#@@Port@@#$(PORT)#g' \
			< $$i > $(sysconfdir)/$$i; \
		chmod 0644 $(sysconfdir)/$$i; \
		file=`echo $$i|sed s/-dist//`; \
		if [ "$$file" = "httpd.conf" ]; then \
			file=`echo $$file|sed s/.*.conf/$(PROGRAM_NAME).conf/`; \
		fi; \
		if test "$$file" != "$$i" && test ! -f $(sysconfdir)/$$file; then \
			$(INSTALL_DATA) $(sysconfdir)/$$i $(sysconfdir)/$$file; \
		fi; \
	done

htdocs-srcdir = $(srcdir)/../htdocs

docs: include/*.h
	mkdir -p ./docs/api
	lib/apr/helpers/scandoc -ihelpers/default.pl -p./docs/api/ ./include/*.h

install-htdocs:
	@echo Installing HTML documents
	@test -d $(htdocsdir) || $(MKINSTALLDIRS) $(htdocsdir)
	@test -d $(htdocs-srcdir) && (cd $(htdocs-srcdir) && cp -rp * $(htdocsdir))

install-icons:
	@echo Installing icons
	@test -d $(iconsdir) || $(MKINSTALLDIRS) $(iconsdir)
	@(cd $(srcdir)/../icons && cp -rp * $(iconsdir))

install-cgi:
	@echo Installing CGIs
	@test -d $(cgidir) || $(MKINSTALLDIRS) $(cgidir)
	@(cd $(srcdir)/../cgi-bin && cp -rp * $(cgidir))

install-support:
	@echo Installing Support Binaries
	@test -d $(bindir) || $(MKINSTALLDIRS) $(bindir)
	@cp -p $(srcdir)/support/httpd.exp $(bindir)
	@cp -p $(builddir)/support/htpasswd $(bindir)
	@cp -p $(builddir)/support/htdigest $(bindir)
	@cp -p $(builddir)/support/rotatelogs $(bindir)
	@cp -p $(builddir)/support/logresolve $(bindir)
	@cp -p $(builddir)/support/ab $(bindir)
	@cp -p $(builddir)/support/apachectl $(bindir)
	chmod 755 $(bindir)/apachectl
	@if test -f $(builddir)/support/apxs; then \
	    cp -p $(builddir)/support/apxs $(bindir); \
	    chmod 755 $(bindir)/apxs; \
	fi


install-other:
	@test -d $(logdir) || $(MKINSTALLDIRS) $(logdir)
	@for ext in dll x; do \
		file=apachecore.$$ext; \
		if test -f $$file; then \
			cp -p $$file $(bindir); \
		fi; \
	done;

install-include:
	@echo Installing header files
	@test -d $(includedir)     || $(MKINSTALLDIRS) $(includedir)
	@test -d $(includedir)/xml || $(MKINSTALLDIRS) $(includedir)/xml
	@test -d $(includedir)/apr || $(MKINSTALLDIRS) $(includedir)/apr
	@cp -p include/*.h $(srcdir)/include/*.h $(includedir)
	@cp -p $(srcdir)/os/$(OS_DIR)/os.h $(includedir)
	@if test -f $(srcdir)/os/$(OS_DIR)/os-inline.c; then \
            cp -p $(srcdir)/os/$(OS_DIR)/os-inline.c $(includedir); \
        fi;
	@cp -p $(srcdir)/modules/dav/main/mod_dav.h $(includedir)
	@cp -p $(srcdir)/lib/expat-lite/*.h $(includedir)/xml
	@cp -p lib/apr/include/*.h $(srcdir)/lib/apr/include/*.h $(includedir)/apr
	@chmod 644 $(includedir)/*.h $(includedir)/xml/*.h $(includedir)/apr/*.h
